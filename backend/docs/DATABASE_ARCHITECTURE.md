# Generated by Claude Sonnet 4.5

# Database Architecture

Complete overview of the three-tier data storage architecture.

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────┐
│                        CLIENT LAYER                          │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              IndexedDB (Dexie.js)                      │ │
│  │  • Local-first storage                                 │ │
│  │  • Offline access                                      │ │
│  │  • UX source of truth                                  │ │
│  │  • Sync state tracking                                 │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                            ↕ Sync
┌─────────────────────────────────────────────────────────────┐
│                        CLOUD LAYER                           │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              Supabase (Postgres + RLS)                 │ │
│  │  • Multi-device sync                                   │ │
│  │  • User authentication                                 │ │
│  │  • File storage (PDFs)                                 │ │
│  │  • Row-level security                                  │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                            ↕ Embed
┌─────────────────────────────────────────────────────────────┐
│                      VECTOR LAYER                            │
│  ┌────────────────────────────────────────────────────────┐ │
│  │                  Pinecone                              │ │
│  │  • Semantic search                                     │ │
│  │  • Vector embeddings                                   │ │
│  │  • User-filtered queries                               │ │
│  │  • Backend service only                                │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 1. IndexedDB (Client)

### Purpose
- **Local-first UX**: Immediate reads/writes
- **Offline access**: Works without internet
- **Cache**: Stores extracted text and chunks
- **Annotations**: User highlights and notes

### Tables

| Table | Purpose |
|-------|---------|
| `documents` | Local document metadata |
| `page_text` | Extracted text from pages |
| `chunks` | Chunked text for embedding |
| `vector_refs` | Chunk → Pinecone vector mapping |
| `highlights` | Range-anchored highlights |
| `notes` | User notes with metadata |
| `sync_state` | Dirty flags & sync timestamps |

### Access Rules
- **Read/Write**: Local user only
- **No cross-origin access**
- **No backend direct access**

### Data Flow
```
User Action → IndexedDB (instant) → Mark dirty → Background sync → Cloud
```

## 2. Supabase (Cloud)

### Purpose
- **Multi-device sync**: Share data across devices
- **Authentication**: User identity management
- **File storage**: Large PDF files
- **Backup**: Cloud persistence

### Tables

| Table | Purpose | RLS Policy |
|-------|---------|------------|
| `documents` | Cloud document metadata | Owner only |
| `highlights` | Synced highlights | Owner only |
| `notes` | Synced notes | Owner only |
| `pdf_files` | PDF storage metadata | Owner only |
| `sync_log` | Sync debugging | Owner read, service write |

### Storage Buckets

| Bucket | Access | Purpose |
|--------|--------|---------|
| `pdfs` | Owner via signed URLs | Permanent PDF storage |
| `temp_uploads` | Owner write, backend read | Temporary upload staging |

### Row Level Security (RLS)

**All tables enforce**:
- `auth.uid() = user_id` for all operations
- Users can only access their own data
- Backend service uses service role key to bypass RLS

### Data Flow
```
Client → Supabase Auth → RLS Check → Postgres → Response
```

## 3. Pinecone (Vector Store)

### Purpose
- **Semantic search**: Find relevant chunks
- **Question answering**: Retrieve context for LLM
- **Cross-document search**: Search across all user docs

### Structure

**Index**: `knowledge-companion`
- **Dimensions**: 384 (BGE-small-en-v1.5)
- **Metric**: Cosine similarity
- **Pod**: s1 (Starter)

### Vector Metadata

```json
{
  "user_id": "uuid",
  "document_id": "uuid",
  "chunk_id": "uuid",
  "page_number": 12,
  "text": "Original chunk text...",
  "char_start": 0,
  "char_end": 500,
  "created_at": "2026-01-11T12:00:00Z"
}
```

### Access Rules
- **Insert**: Backend service only
- **Query**: Backend service only
- **Delete**: Backend service only
- **Filter**: Always by `user_id`

### Data Flow
```
Client → Backend API → Embed text → Pinecone upsert
Client → Backend API → Embed query → Pinecone search → Filter by user_id
```

## Data Synchronization

### Sync Strategy

**Local-first with eventual consistency**:

1. **Write**: Always to IndexedDB first
2. **Mark dirty**: Set `is_dirty = true` in `sync_state`
3. **Background sync**: Push to Supabase when online
4. **Pull sync**: Fetch remote changes periodically
5. **Conflict resolution**: Last-write-wins (initially)

### Sync State Tracking

```typescript
interface SyncState {
  entity_type: 'document' | 'highlight' | 'note';
  entity_id: string;
  is_dirty: boolean;
  last_synced_at?: string;
  sync_error?: string;
}
```

### Sync Flow

```
┌─────────────┐
│ User Action │
└──────┬──────┘
       ↓
┌─────────────┐
│  IndexedDB  │ (instant)
│  is_dirty=1 │
└──────┬──────┘
       ↓
┌─────────────┐
│ Background  │
│ Sync Worker │
└──────┬──────┘
       ↓
┌─────────────┐
│  Supabase   │ (when online)
│  RLS Check  │
└──────┬──────┘
       ↓
┌─────────────┐
│  Success    │
│ is_dirty=0  │
└─────────────┘
```

## Security Model

### Client (IndexedDB)
- **Isolation**: Per-origin storage
- **No encryption**: Browser handles security
- **Access**: Same-origin only

### Cloud (Supabase)
- **Authentication**: JWT tokens
- **Authorization**: Row Level Security
- **Encryption**: At rest and in transit
- **Audit**: All queries logged

### Vector Store (Pinecone)
- **API Key**: Backend service only
- **Filtering**: Always by user_id
- **No direct client access**
- **Metadata**: No sensitive data

## Performance Considerations

### IndexedDB
- **Fast**: Sub-millisecond reads
- **Indexed**: All foreign keys indexed
- **Limits**: ~50MB typical, browser-dependent

### Supabase
- **Latency**: 50-200ms typical
- **Throughput**: 1000s of requests/sec
- **Limits**: Connection pooling, rate limits

### Pinecone
- **Latency**: 50-100ms typical
- **Throughput**: Depends on pod type
- **Limits**: Free tier: 100K vectors

## Monitoring

### Key Metrics

**IndexedDB**:
- Storage usage per user
- Sync queue depth
- Failed sync attempts

**Supabase**:
- Active connections
- Query latency
- Storage usage
- Failed auth attempts

**Pinecone**:
- Query latency
- Vector count
- Query volume
- Error rate

## Backup & Recovery

### IndexedDB
- **Backup**: Sync to Supabase
- **Recovery**: Pull from Supabase
- **Data loss**: Possible if browser clears storage

### Supabase
- **Backup**: Automatic daily backups
- **Recovery**: Point-in-time restore
- **Retention**: 7 days (free tier)

### Pinecone
- **Backup**: No built-in backup
- **Recovery**: Re-embed from Supabase
- **Strategy**: Treat as cache, not source of truth

## Migration Strategy

### Schema Changes

**IndexedDB**:
```typescript
this.version(2).stores({
  // Add new table
  new_table: 'id, field1, field2'
}).upgrade(tx => {
  // Migrate existing data
});
```

**Supabase**:
```sql
-- Create migration file
-- migrations/003_add_new_field.sql
ALTER TABLE documents ADD COLUMN new_field TEXT;
```

**Pinecone**:
- Cannot modify index dimensions
- Create new index if needed
- Migrate vectors via re-embedding

## Cost Analysis

### Free Tier Limits

**Supabase**:
- 500 MB database
- 1 GB file storage
- 2 GB bandwidth/month

**Pinecone**:
- 1 index
- 100K vectors
- Unlimited queries

### Estimated Costs (1000 users)

**Supabase**: $25-50/month
- Pro plan for more storage
- Additional bandwidth

**Pinecone**: $70-100/month
- s1.x1 pod for 1M vectors
- ~100 chunks per document
- ~10 documents per user

**Total**: ~$100-150/month for 1000 active users
